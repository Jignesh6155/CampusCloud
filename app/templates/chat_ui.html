{% extends "base.html" %}
{% block content %}
<!-- üî≤ Outer padding wrapper for spacing on all sides -->
<div class="p-4 h-screen bg-slate-100/80">
  <div id="pageContainer" class="h-full flex bg-white/80 rounded-xl shadow-xl border border-gray-200/60 backdrop-blur">
  
  <!-- ‚ñ∏ Sidebar (Unit Navigation) -->
  <div class="flex h-full w-[20rem] flex-col bg-gradient-to-b from-gray-100/80 to-gray-200/80 border-r border-gray-300 border-l border-white/50 backdrop-blur-md rounded-l-xl shadow-xl z-10">
    <a href="/forums" class="text-indigo-600 text-sm hover:underline block px-5 pt-5 mb-4 transition">
      ‚Üê Back to Forums
    </a>
    <h1 class="text-xl font-semibold text-gray-800 text-center mb-4 px-4 tracking-wide">
      {{ unit_code|upper }} Discussion
    </h1>

    <nav class="flex-1 overflow-y-auto text-sm font-medium px-4 py-3 space-y-6">

      <!-- üìÅ Main Channels -->
      <div class="space-y-1">
        <div class="text-xs text-gray-500 px-2 mb-1 uppercase tracking-wide">Main</div>
    
        <div role="button"
             class="tab-btn flex items-center w-full gap-3 px-4 py-2 rounded-xl group transition-all duration-150 hover:bg-indigo-100 hover:text-indigo-700 relative"
             data-channel="general">
          <div class="w-1.5 h-full absolute left-0 top-0 rounded-r bg-indigo-500 opacity-0 group-hover:opacity-100 transition"></div>
          <i class="fas fa-comments w-4 h-4 text-slate-500 group-hover:text-indigo-600 transition"></i>
          <span class="truncate font-medium">General</span>
          <span class="ml-auto bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-semibold">2</span>
        </div>
      </div>
    
      <!-- üß© Topic Channels -->
      <div class="space-y-1">
        <div class="text-xs text-gray-500 px-2 mb-1 uppercase tracking-wide">Topics</div>
    
        <div role="button"
             class="tab-btn flex items-center w-full gap-3 px-4 py-2 rounded-xl group transition-all duration-150 hover:bg-indigo-100 hover:text-indigo-700 relative"
             data-channel="assignments">
          <div class="w-1.5 h-full absolute left-0 top-0 rounded-r bg-indigo-500 opacity-0 group-hover:opacity-100 transition"></div>
          <i class="fas fa-tasks w-4 h-4 text-slate-500 group-hover:text-indigo-600 transition"></i>
          <span class="truncate font-medium">Assignments</span>
          <span class="ml-auto bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-semibold">5</span>
        </div>
    
        <div role="button"
             class="tab-btn flex items-center w-full gap-3 px-4 py-2 rounded-xl group transition-all duration-150 hover:bg-indigo-100 hover:text-indigo-700 relative"
             data-channel="resources">
          <div class="w-1.5 h-full absolute left-0 top-0 rounded-r bg-indigo-500 opacity-0 group-hover:opacity-100 transition"></div>
          <i class="fas fa-folder-open w-4 h-4 text-slate-500 group-hover:text-indigo-600 transition"></i>
          <span class="truncate font-medium">Resources</span>
          <span class="ml-auto bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-semibold">1</span>
        </div>
      </div>
    </nav>
  </div>

<!-- ‚ñ∏ Chat Area -->
<div class="flex-1 flex flex-col h-full">
  <div class="relative h-full overflow-y-auto">

    <!-- Classic Chat -->
    <div id="classic-chat" class="h-full overflow-y-auto">
      <div id="chat-messages" class="space-y-4 p-4">
        <!-- Messages injected by JS -->
      </div>
    </div>

    <!-- General SMS-Style Chat -->
    <div id="general-chat-container" class="hidden h-full bg-gradient-to-b from-white to-slate-100 rounded-r-xl border-l border-gray-200 shadow-lg">
      <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="p-4 border-b flex justify-between items-center bg-white shadow-sm">
          <div class="font-bold text-gray-700 text-lg">General Chat</div>
          <i class="fa fa-ellipsis-h text-gray-400"></i>
        </div>

        <!-- ‚úÖ ADD THIS dynamic message container -->
        <div id="general-messages" class="flex-1 px-6 py-4 overflow-y-auto space-y-6">
          <!-- Messages will be injected here -->
        </div>

        <!-- Input Bar -->
        <div class="p-4 border-t bg-gradient-to-r from-stone-100 to-gray-100 border-gray-200/60 flex items-center gap-3 shadow-sm">
          <button class="text-gray-400 hover:text-indigo-400 transition">
            <i class="fa fa-smile-o text-xl"></i>
          </button>
          <input
            id="general-input"
            type="text"
            placeholder="Type your message..."
            class="flex-1 bg-white border border-gray-200 rounded-full px-5 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-200 shadow-sm"
          />
          <button id="general-send-btn" class="text-white bg-indigo-600 hover:bg-indigo-700 transition px-4 py-2 rounded-full shadow-md">
            <i class="fa fa-paper-plane-o text-sm"></i>
          </button>
        </div>
      </div>
    </div>

<!-- üìö Assignments Forum Layout -->
<div id="assignments-chat-container" class="hidden h-full bg-gradient-to-b from-white to-slate-100 rounded-r-xl border-l border-gray-200 shadow-lg">
  <div class="flex flex-col h-full">

    <!-- üî∑ Header -->
    <div class="p-4 border-b flex justify-between items-center bg-white shadow-sm">
      <h2 class="font-bold text-gray-700 text-lg">Assignment Help Board</h2>
      <i class="fa fa-clipboard-list text-gray-400"></i>
    </div>

    <!-- üî∂ Posts Feed -->
    <div id="assignments-messages" class="flex-1 px-6 py-4 overflow-y-auto space-y-6">
      {% for msg in assignment_messages %}
        <div class="post-card relative rounded-xl shadow border border-slate-200 p-4 bg-white" id="msg-{{ msg.id }}">

          {# ‚ñ∏ Delete button (visible only to author) #}
          {% if msg.user_id == current_user.id %}
            <button onclick="showDeleteModal('{{ msg.id }}')"
                    class="absolute top-3 right-3 text-slate-400 hover:text-red-600
                          font-bold text-lg leading-none transition-opacity
                          opacity-0 hover:opacity-100">
              &times;
            </button>
          {% endif %}

          <div class="flex items-center gap-3 mb-2">
            <img src="{{ msg.user.profile_picture or 'https://cdn-icons-png.flaticon.com/512/149/149071.png' }}"
                class="w-10 h-10 rounded-full border border-slate-300" />
            <div>
              <h3 class="text-sm font-semibold text-slate-800">
                {{ msg.user.display_name or msg.author }}
              </h3>
              <p class="text-xs text-slate-500">
                Posted {{ msg.timestamp.strftime('%b %d, %I:%M %p') }}
              </p>
            </div>
          </div>

          <p class="text-sm text-slate-700 whitespace-pre-line">{{ msg.message }}</p>
        </div>
      {% else %}
        <div class="text-sm text-gray-500 italic">
          No assignment messages yet. Be the first to post a question!
        </div>
      {% endfor %}
    </div>

    <!-- üìù Input Bar -->
    <div class="p-4 border-t bg-gradient-to-r from-slate-50 to-gray-100 border-gray-200 flex items-center gap-3 shadow-sm">
      <button class="text-gray-400 hover:text-indigo-500 transition">
        <i class="fa fa-question-circle text-xl"></i>
      </button>
      <input
        id="assignments-input"
        type="text"
        placeholder="Post a question about the assignment..."
        class="flex-1 bg-white border border-gray-200 rounded-full px-5 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-200 shadow-sm"
      />
      <button id="assignments-send-btn" class="text-white bg-indigo-600 hover:bg-indigo-700 transition px-4 py-2 rounded-full shadow-md">
        <i class="fa fa-paper-plane text-sm"></i>
      </button>
    </div>

      </div> <!--  ‚óÄ‚îÄ end .p-4 (input bar inside assignments-chat-container) -->
    </div>     <!--  ‚óÄ‚îÄ end #assignments-chat-container -->
  </div>       <!--  ‚óÄ‚îÄ end .relative (Chat Area) -->
</div>       <!--  ‚óÄ‚îÄ end #pageContainer -->

    <!-- üóëÔ∏è Delete Confirmation Modal  (now lives outside any chat tab) -->
    <div id="deleteModal"
      class="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm
              flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 shadow-lg max-w-sm w-full text-center">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Delete Message?</h2>
      <p class="text-sm text-gray-600 mb-6">
        Are you sure you want to delete this message? This action cannot be undone.
      </p>
      <div class="flex justify-center gap-4">
        <button onclick="hideDeleteModal()"
                class="px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700">
          Cancel
        </button>
        <button id="confirmDeleteBtn"
                class="px-4 py-2 rounded-full bg-red-600 hover:bg-red-700 text-white">
          Delete
        </button>
      </div>
    </div>
    </div>
<!-- Slide-in animation -->
<style>
  #pageContainer { transform: translateX(100%); opacity: 0; }
  #pageContainer.slide-in { animation: slideIn 0.6s ease forwards; }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to   { transform: translateX(0);     opacity: 1; }
  }

  body {
    background-color: rgba(241, 245, 249, 0.8); /* slate-100 w/ tint */
    backdrop-filter: blur(6px);
  }
</style>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const unitCode = "{{ unit_code }}";
  const CURRENT_USER_ID = "{{ current_user.id }}";
  const CURRENT_USER_NAME = "{{ current_user.display_name }}";
  let currentChannel = "general";
  let deleteMessageId = null;

  const messagesBox     = document.getElementById("chat-messages");
  const tabBtns         = document.querySelectorAll(".tab-btn");
  const classicChat     = document.getElementById("classic-chat");
  const generalChat     = document.getElementById("general-chat-container");
  const assignmentsChat = document.getElementById("assignments-chat-container");
  const assignmentsMessagesBox = document.getElementById("assignments-messages");
  const socket = io();

  // Socket Join
  socket.emit("join", {
    unit_code: unitCode,
    channel: currentChannel,
    author: CURRENT_USER_NAME
  });

  // üîÅ Load all messages
  async function loadMessages() {
    const res  = await fetch(`/units/${unitCode}/messages?channel=${currentChannel}`);
    const data = await res.json();

    if (currentChannel === "general") {
      const container = document.getElementById("general-messages");
      container.innerHTML = "";
      data.forEach(addGeneralMsg);
      container.scrollTop = container.scrollHeight;
    } else if (currentChannel === "assignments") {
      assignmentsMessagesBox.innerHTML = "";
      data.forEach(addAssignmentMsg);          // renamed helper
      assignmentsMessagesBox.scrollTop = assignmentsMessagesBox.scrollHeight;
    }
  }

  // helper for assignments
  function addAssignmentMsg(m) {
    const wrap = document.createElement("div");
    wrap.id = `msg-${m.id}`;
    wrap.className = "post-card relative rounded-xl shadow border border-slate-200 p-4 bg-white";

    const isCurrentUser = Number(m.user_id) === Number(CURRENT_USER_ID);

    wrap.innerHTML = `
      ${isCurrentUser ? `
        <button onclick="showDeleteModal('${m.id}')"
                class="absolute top-3 right-3 text-slate-400 hover:text-red-600
                      font-bold text-lg leading-none transition-opacity
                      opacity-0 hover:opacity-100">
          &times;
        </button>` : ''
      }

      <div class="flex items-center gap-3 mb-2">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
            class="w-10 h-10 rounded-full border border-slate-300" />
        <div>
          <h3 class="text-sm font-semibold text-slate-800">${m.author}</h3>
          <p class="text-xs text-slate-500">
            ${new Date(m.timestamp).toLocaleString()}
          </p>
        </div>
      </div>
      <p class="text-sm text-slate-700">${m.message}</p>
    `;

    assignmentsMessagesBox.appendChild(wrap);
  }
  
  function addGeneralMsg(m) {
    const wrap = document.createElement("div");
    wrap.id = `msg-${m.id}`;
    const isCurrentUser = Number(m.user_id) === Number(CURRENT_USER_ID);
  
    if (isCurrentUser) {
      wrap.className = "flex justify-end pr-2";
      wrap.innerHTML = `
        <div class="relative max-w-md text-right group">
          <div class="relative bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-br-none shadow-md">
            <!-- ‚ùå Hidden by default, shows on hover -->
            <button onclick="showDeleteModal('${m.id}')"
                    class="absolute top-2 right-2 text-white/70 hover:text-white text-sm font-bold leading-none z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              &times;
            </button>
            <p class="text-sm leading-relaxed break-words">${m.message}</p>
          </div>
          <div class="text-xs text-gray-400 mt-1">
            ${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </div>
        </div>
      `;
    } else {
      wrap.className = "flex items-start gap-3";
      wrap.innerHTML = `
        <img src="${m.profile_picture || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
             class="w-10 h-10 rounded-full object-cover border border-gray-300 shadow-sm"
             alt="${m.author || 'User'} avatar" />
        <div>
          <div class="bg-white border border-gray-200 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm max-w-md">
            <div class="font-semibold text-gray-800 text-sm mb-1">${m.author || 'Anonymous'}</div>
            <p class="text-sm text-gray-800 leading-relaxed break-words">${m.message}</p>
          </div>
          <div class="text-xs text-gray-400 mt-1">
            ${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </div>
        </div>
      `;
    }
  
    document.getElementById("general-messages").appendChild(wrap);
  }

  function addMsg(m) {
    const wrap = document.createElement("div");
    wrap.id = `msg-${m.id}`;
    wrap.className = "post-card rounded-xl shadow border border-slate-200 p-4 bg-white";
    wrap.innerHTML = `
      <div class="flex items-center gap-3 mb-2">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-10 h-10 rounded-full border border-slate-300" />
        <div>
          <h3 class="text-sm font-semibold text-slate-800">${m.author}</h3>
          <p class="text-xs text-slate-500">${new Date(m.timestamp).toLocaleString()}</p>
        </div>
      </div>
      <p class="text-sm text-slate-700">${m.message}</p>
    `;

    messagesBox.appendChild(wrap);
  }

  document.getElementById("assignments-send-btn").addEventListener("click", () => {
    const input = document.getElementById("assignments-input");
    const msg = input.value.trim();
    if (!msg) return;
  
    socket.emit("send_message", {
      unit_code: unitCode,
      channel: currentChannel,  // should be 'assignments' at this point
      message: msg,
      user_id: CURRENT_USER_ID,
      author: CURRENT_USER_NAME
    });
  
    input.value = "";
  });

  // üß≠ Tabs
  tabBtns.forEach(btn =>
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => {
        b.classList.remove("bg-indigo-50", "text-indigo-700", "font-semibold");
        const indicator = b.querySelector("div.w-1\\.5");
        if (indicator) indicator.classList.add("opacity-0");
      });

      btn.classList.add("bg-indigo-50", "text-indigo-700", "font-semibold");
      const currentIndicator = btn.querySelector("div.w-1\\.5");
      if (currentIndicator) currentIndicator.classList.remove("opacity-0");

      currentChannel = btn.dataset.channel;
      socket.emit("join", { unit_code: unitCode, channel: currentChannel });

      generalChat.classList.toggle("hidden", currentChannel !== "general");
      assignmentsChat.classList.toggle("hidden", currentChannel !== "assignments");
      classicChat.classList.toggle("hidden", currentChannel === "general" || currentChannel === "assignments");

      loadMessages();
    })
  );

  // ‚úâÔ∏è Send button
  document.getElementById("general-send-btn").addEventListener("click", () => {
    const input = document.getElementById("general-input");
    const msg = input.value.trim();
    if (!msg) return;

    socket.emit("send_message", {
      unit_code: unitCode,
      channel: currentChannel,
      message: msg,
      user_id: CURRENT_USER_ID,
      author: CURRENT_USER_NAME
    });

    input.value = "";
  });

  socket.on("receive_message", data => {
    if (data.unit_code === unitCode && data.channel === currentChannel) {
      const msgData = { ...data };
      if (currentChannel === "general") {
        addGeneralMsg(msgData);
        document.getElementById("general-messages").scrollTop =
          document.getElementById("general-messages").scrollHeight;
      } else if (currentChannel === "assignments") {
        addAssignmentMsg(msgData);
        assignmentsMessagesBox.scrollTop = assignmentsMessagesBox.scrollHeight;
      }
    }
  });

  // ü™Ñ Slide-in
  window.addEventListener("DOMContentLoaded", () => {
    requestAnimationFrame(() =>
      requestAnimationFrame(() =>
        document.getElementById("pageContainer").classList.add("slide-in")
      )
    );
    loadMessages();
  });

  // üßº Modal control
  function showDeleteModal(msgId) {
    deleteMessageId = msgId;
    document.getElementById("deleteModal").classList.remove("hidden");
  }

  function hideDeleteModal() {
    deleteMessageId = null;
    document.getElementById("deleteModal").classList.add("hidden");
  }

  // üóëÔ∏è Confirm Delete
  document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    if (deleteMessageId) {
      const res = await fetch(`/delete-message/${deleteMessageId}`, { method: "DELETE" });
      if (res.ok) {
        const el = document.getElementById(`msg-${deleteMessageId}`);
        if (el) el.remove();
      }
      hideDeleteModal();
    }
  });
</script>
{% endblock %}

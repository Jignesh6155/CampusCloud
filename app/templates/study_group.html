<!-- study_group.html -->
{% extends "base.html" %}
{% block content %}

<!-- Title bar -->
<div class="w-full bg-slate-100 text-slate-800 py-6 px-6 flex items-center gap-2">
  <h1 class="text-2xl font-bold">Study & Social Meetups</h1>
  <span class="text-2xl">ü§ù</span>
</div>

<div class="p-4 bg-slate-100">
  <div class="max-w-6xl mx-auto flex gap-4">

    <!-- Left Sidebar: Post a Meetup -->
    <div class="w-1/3 -ml-10 bg-white border border-slate-200 rounded-xl shadow p-4 flex flex-col gap-4 sticky top-6 h-auto overflow-auto">
      <h2 class="text-lg font-semibold text-slate-700">Post a Meetup</h2>
      <form method="POST" action="/study-groups/new" class="flex flex-col gap-3 text-sm">
        <input name="title" type="text" placeholder="Topic / Subject" class="border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm" required />
        <input name="location" type="text" placeholder="Location" class="border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm" />
        <input name="time" type="datetime-local" class="border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm" />
        <select name="type" class="border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
          <option value="">Type</option>
          <option value="Study">Study</option>
          <option value="Social">Social</option>
          <option value="Other">Other</option>
        </select>
        <textarea name="description" placeholder="Description..." rows="4" class="border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm"></textarea>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="anonymous" name="anonymous" class="h-4 w-4 text-indigo-600 border-slate-300 rounded">
          <label for="anonymous" class="text-sm text-slate-600">Post anonymously</label>
        </div>

        <button type="submit" class="bg-indigo-600 text-white px-3 py-2 rounded-full hover:bg-indigo-700 transition font-semibold shadow-sm">
          Post Meetup
        </button>
      </form>
    </div>

    <!-- Right: Meetup posts list -->
    <div class="w-2/3 max-h-[80vh] overflow-y-auto pr-2 space-y-4">
      {% for meetup in meetups %}
        <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-800">{{ meetup.title }}</h3>
            <span class="px-2 py-1 text-xs rounded-full 
              {% if meetup.type == 'Study' %} bg-indigo-100 text-indigo-600
              {% elif meetup.type == 'Social' %} bg-green-100 text-green-600
              {% else %} bg-slate-100 text-slate-600 {% endif %}">
              {{ meetup.type }}
            </span>
          </div>

          {% if not meetup.user or anonymous %}
            <span class="text-xs text-slate-400 mb-1 italic">Anonymous</span>
          {% else %}
            <a href="#" class="text-xs text-indigo-600 hover:underline mb-1">
              {{ meetup.user.display_name }}
            </a>
          {% endif %}

          <p class="text-xs text-slate-600">üìç {{ meetup.location }} | üïí 
            {% if meetup.time %}{{ meetup.time.strftime('%b %d, %I:%M %p') }}{% else %}TBA{% endif %}
          </p>

          <p class="text-slate-700 text-sm">{{ meetup.description }}</p>

          <div class="flex items-center justify-between mt-2 text-xs text-slate-600">
            <button onclick="rsvp({{ meetup.id }})" class="flex items-center space-x-1 text-indigo-600 hover:underline transition">
              <i class="fas fa-user-plus"></i>
              <span id="rsvp-count-{{ meetup.id }}">RSVP ({{ meetup.rsvp_count }} coming)</span>
            </button>
            <div class="flex gap-1">
              <span class="bg-slate-100 px-2 py-1 rounded-full lowercase">{{ meetup.type }}</span>
              {% if 'study' in meetup.title.lower() %}
                <span class="bg-slate-100 px-2 py-1 rounded-full">study</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% else %}
        <p class="text-center text-gray-500 italic">No meetups posted yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function rsvp(meetupId) {
  fetch(`/study-groups/rsvp/${meetupId}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        document.getElementById(`rsvp-count-${meetupId}`).innerText = `RSVP (${data.rsvp_count} coming)`;
      }
    });
}
</script>

{% endblock %}

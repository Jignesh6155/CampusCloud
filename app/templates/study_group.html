{% extends "base.html" %}
{% block content %}

<!-- ‚ñ£ Top Bar -->
<div class="w-full bg-slate-100 text-slate-800 py-6 px-6 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <h1 class="text-2xl font-bold">Study &amp; Social Meetups</h1>
    <span class="text-2xl">ü§ù</span>
  </div>

  <button onclick="document.getElementById('meetupModal').classList.remove('hidden')"
          class="mt-4 mr-8 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium px-4 py-2 rounded-full shadow transition">
    + Post Meetup
  </button>
</div>

<!-- ‚ñ£ Main Content -->
<div class="py-10 px-4 bg-slate-100">
  <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-10">

    <!-- ‚ó§ Tutors Column -->
    <aside class="hidden lg:flex flex-col w-80 shrink-0">

      <!-- Tutors Title -->
      <h2 class="text-base font-semibold text-slate-700 mt-2 mb-4">Tutors at UWA</h2>

      <!-- Scrollable Tutors -->
      <div class="h-[70vh] overflow-y-scroll pr-6 border-r-2 border-dashed border-slate-300/70 space-y-6">

        <!-- Tutor Card -->
        <article class="bg-gray-50 rounded-2xl border border-slate-400 shadow-sm p-5 flex flex-col gap-3 hover:shadow-md transition">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-slate-700 font-semibold">B</div>
            <div>
              <h4 class="font-semibold text-slate-800">Bob</h4>
              <p class="text-sm text-slate-500">Coding Tutor</p>
            </div>
          </div>
          <p class="text-sm text-slate-700">$40&nbsp;/&nbsp;hr ‚Ä¢ Online &amp; Perth</p>
          <button class="self-start mt-1 text-xs font-medium text-indigo-600 hover:underline">Contact</button>
        </article>

        <article class="bg-gray-50 rounded-2xl border border-slate-400 shadow-sm p-5 flex flex-col gap-3 hover:shadow-md transition">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-slate-700 font-semibold">A</div>
            <div>
              <h4 class="font-semibold text-slate-800">Alice</h4>
              <p class="text-sm text-slate-500">Calculus Tutor</p>
            </div>
          </div>
          <p class="text-sm text-slate-700">$35&nbsp;/&nbsp;hr ‚Ä¢ UWA Library</p>
          <button class="self-start mt-1 text-xs font-medium text-indigo-600 hover:underline">Contact</button>
        </article>

        <article class="bg-gray-50 rounded-2xl border border-slate-400 shadow-sm p-5 flex flex-col gap-3 hover:shadow-md transition">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-slate-700 font-semibold">C</div>
            <div>
              <h4 class="font-semibold text-slate-800">Chen</h4>
              <p class="text-sm text-slate-500">IELTS English Tutor</p>
            </div>
          </div>
          <p class="text-sm text-slate-700">$30&nbsp;/&nbsp;hr ‚Ä¢ Online</p>
          <button class="self-start mt-1 text-xs font-medium text-indigo-600 hover:underline">Contact</button>
        </article>

        <!-- Post-an-ad Placeholder -->
        <div class="bg-gray-50 rounded-2xl border-2 border-dashed border-slate-400 p-6 text-center flex flex-col items-center gap-4">
          <p class="text-sm text-slate-600 font-medium">Post an ad</p>
          <button class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold px-4 py-1.5 rounded-full shadow transition">
            Pay &amp; Post
          </button>
        </div>

      </div>
    </aside>

    <!-- ‚ó¢ Meetups Column -->
    <div class="flex-1 flex flex-col">

      <!-- Meetups Title -->
      <h2 class="text-base font-semibold text-slate-700 mt-2 mb-4">Meetup Listings</h2>

      <!-- Scrollable Meetups -->
      <div class="h-[70vh] overflow-y-scroll pr-2 flex flex-col gap-10">
        <section class="w-full space-y-6">
          {% for meetup in meetups %}
            <article id="meetup-{{ meetup.id }}"
                     class="relative bg-white rounded-2xl shadow-[0_1px_4px_rgba(0,0,0,0.05)] p-6 flex flex-col gap-3 ring-1 ring-slate-100 hover:ring-slate-200 transition
                     {% if meetup.time %}
                       {% if meetup.time > now %} border border-green-200
                       {% else %} border border-red-200
                       {% endif %}
                     {% else %} border border-slate-200
                     {% endif %}">
              {% if meetup.user_id == current_user.id %}
                <button onclick="deleteMeetup({{ meetup.id }})"
                        class="absolute top-3 right-4 text-slate-400 hover:text-red-600 transition text-lg"
                        title="Delete this meetup">&times;</button>
              {% endif %}

              <header class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                  {{ meetup.title }}
                  {% if meetup.unit_code %}
                    <span class="text-sm text-slate-500 font-normal">‚Ä¢ {{ meetup.unit_code }}</span>
                  {% endif %}
                </h3>
                <span class="px-2 py-0.5 rounded-full text-xs
                      {% if meetup.type == 'Study' %} bg-indigo-50 text-indigo-600
                      {% elif meetup.type == 'Social' %} bg-green-50 text-green-600
                      {% else %} bg-slate-50 text-slate-600 {% endif %}">
                  {{ meetup.type }}
                </span>
              </header>

              {% if meetup.anonymous %}
                {% if meetup.user_id == current_user.id %}
                  <span class="text-xs text-slate-400 italic">You (anonymous)</span>
                {% else %}
                  <span class="text-xs text-slate-400 italic">Anonymous</span>
                {% endif %}
              {% elif meetup.user %}
                <a href="{{ url_for('routes.view_profile', user_id=meetup.user.id) }}"
                   class="text-xs text-indigo-600 hover:underline">
                  {{ meetup.user.display_name }}
                </a>
              {% endif %}

              <p class="text-xs text-slate-600">
                üìç {{ meetup.location or "TBA" }} &nbsp;|&nbsp;
                üïí {% if meetup.time %}{{ meetup.time.strftime('%b %d ‚Ä¢ %I:%M %p') }}{% else %}TBA{% endif %}
              </p>

              <p class="text-slate-700 text-sm leading-relaxed">{{ meetup.description }}</p>

              <footer class="flex items-center justify-between pt-2 border-t text-xs text-slate-600">
                <button onclick="toggleRSVP({{ meetup.id }})"
                        class="flex items-center gap-1 text-indigo-600 hover:underline transition font-medium"
                        id="rsvp-btn-{{ meetup.id }}">
                  <i class="fas fa-user-plus"></i>
                  <span id="rsvp-count-{{ meetup.id }}">RSVP ({{ meetup.rsvped_users | length }} coming)</span>
                </button>
                <div class="flex flex-wrap gap-1">
                  <span class="bg-slate-100 px-2 py-0.5 rounded-full lowercase">{{ meetup.type }}</span>
                  {% if 'study' in meetup.title.lower() %}
                    <span class="bg-slate-100 px-2 py-0.5 rounded-full lowercase">study</span>
                  {% endif %}
                </div>
              </footer>
            </article>
          {% else %}
            <p class="text-center text-gray-500 italic">No meetups posted yet.</p>
          {% endfor %}
        </section>
      </div>
    </div>
  </div>
</div>


<!-- üî≥ Post a Meetup Modal -->
<div id="meetupModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white max-w-md w-full mx-4 p-6 rounded-xl shadow-lg relative">
    <button onclick="document.getElementById('meetupModal').classList.add('hidden')"
            class="absolute top-3 right-4 text-slate-400 hover:text-red-500 text-lg font-bold">&times;</button>

    <h2 class="text-lg font-semibold text-slate-700 mb-4">Post a Meetup</h2>

    <form action="/study-groups/new" method="POST" class="flex flex-col gap-5 text-sm">

      <!-- Title -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Topic / Subject<span class="text-red-500">*</span></span>
        <input name="title" type="text" required
               class="w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm placeholder-slate-400 
                      focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition"
               placeholder="e.g. Calculus revision" />
      </label>

      <!-- Location -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Location<span class="text-red-500">*</span></span>
        <input name="location" type="text" required placeholder="Library G.20"
               class="w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm placeholder-slate-400 
                      focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition" />
      </label>

      <!-- Date & Time -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Date &amp; Time<span class="text-red-500">*</span></span>
        <input name="time" type="datetime-local" required
               class="w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm placeholder-slate-400 
                      focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition" />
      </label>

      <!-- Unit Code (optional) -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Unit Code <span class="text-slate-400 text-xs">(optional)</span></span>
        <input name="unit_code" type="text" placeholder="e.g. MATH1011"
               class="uppercase tracking-wide w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm 
                      placeholder-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition" />
      </label>

      <!-- Type -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Type<span class="text-red-500">*</span></span>
        <select name="type" required
                class="w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm text-slate-700 
                       focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition">
          <option value="">Select a type‚Ä¶</option>
          <option value="Study">Study</option>
          <option value="Social">Social</option>
          <option value="Other">Other</option>
        </select>
      </label>

      <!-- Description -->
      <label class="flex flex-col gap-1">
        <span class="font-medium text-slate-600">Description<span class="text-red-500">*</span></span>
        <textarea name="description" rows="4" required minlength="5" maxlength="500"
                  placeholder="What will be covered?"
                  class="w-full rounded-lg border border-slate-300 bg-white/90 px-3 py-2 shadow-sm placeholder-slate-400 
                         resize-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300/40 transition"></textarea>
      </label>

      <!-- Anonymous toggle -->
      <label class="flex items-center gap-2 text-sm text-slate-600 select-none">
        <input type="checkbox" name="anonymous"
               class="shrink-0 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
        Post anonymously
      </label>

      <button type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-full shadow transition">
        Post Meetup
      </button>
    </form>
  </div>
</div>

<script>
    function toggleRSVP(id){
      fetch(`/study-groups/rsvp/${id}`, { method: 'POST' })
        .then(r => r.json()).then(d => {
          const c = document.getElementById(`rsvp-count-${id}`);
          const b = document.getElementById(`rsvp-btn-${id}`);
          if (d.status === "added") {
            c.textContent = `RSVP (${d.rsvp_count} coming)`;
            b.classList.add('font-semibold');
          } else if (d.status === "removed") {
            c.textContent = `RSVP (${d.rsvp_count} coming)`;
            b.classList.remove('font-semibold');
          }
        });
    }
    
    function deleteMeetup(id){
      if (!confirm("Delete this meetup?")) return;
      fetch(`/study-groups/delete/${id}`, { method: 'POST' })
        .then(r => r.json()).then(d => {
          if (d.status === "deleted") {
            document.getElementById(`meetup-${id}`)?.remove();
          } else {
            alert(d.message || "Could not delete.");
          }
        }).catch(() => alert("Network error, try again."));
    }
    </script>
    

{% endblock %}
